<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Game Plan 11B – Season 25-26</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header class="main-header">
    <img src="images/CUP10.PNG" alt="Team Logo" class="logo" />
    <h1>Game Plan 11B – Season 25-26</h1>
  </header>
  <section id="calendar"></section>
  <script>
    Promise.all([
      fetch('game_meta.json').then(r => r.json()),
      fetch('games.json').then(r => r.json())
    ]).then(([meta, games]) => {
      // Helper to color score
      function scoreClass(score) {
        if (!score) return '';
        const parts = score.split('-');
        if (parts.length !== 2) return '';
        const us = parseInt(parts[0], 10);
        const them = parseInt(parts[1], 10);
        if (isNaN(us) || isNaN(them)) return '';
        if (us > them) return 'score-win';
        if (us < them) return 'score-lose';
        return 'score-draw';
      }

      // Helper: find game for a given date
      function findGameForDate(games, date) {
        return games.find(g => {
          const gameDate = new Date(g.date);
          return gameDate.toDateString() === date.toDateString();
        });
      }

      // Helper: get all weekends between start and end
      function getAllWeekends(startDate, endDate) {
        const weekends = [];
        let d = new Date(startDate);
        d.setDate(d.getDate() + (6 - d.getDay())); // move to Saturday
        while (d <= endDate) {
          const saturday = new Date(d);
          const sunday = new Date(d);
          sunday.setDate(saturday.getDate() + 1);
          weekends.push({
            saturday,
            sunday
          });
          d.setDate(d.getDate() + 7);
        }
        return weekends;
      }

      // Get min/max date from meta
      const allDates = meta.map(g => new Date(g.date)).filter(d => !isNaN(d));
      const seasonStart = new Date(Math.min(...allDates));
      const seasonEnd = new Date(Math.max(...allDates));
      const weekends = getAllWeekends(seasonStart, seasonEnd);

      // Build a lookup for extra game details
      const gameMap = {};
      games.forEach(g => gameMap[g.id] = g);

      // Render
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = weekends.map(({saturday, sunday}) => {
        const satGame = meta.find(g => new Date(g.date).toDateString() === saturday.toDateString());
        const sunGame = meta.find(g => new Date(g.date).toDateString() === sunday.toDateString());
        const satDetails = satGame ? { ...satGame, ...gameMap[satGame.id] } : null;
        const sunDetails = sunGame ? { ...sunGame, ...gameMap[sunGame.id] } : null;
        // Short date format for header
        const header = `${saturday.toLocaleDateString('en-US', { year: '2-digit', month: 'numeric', day: 'numeric' })} - ${sunday.toLocaleDateString('en-US', { year: '2-digit', month: 'numeric', day: 'numeric' })}`;
        return `
          <h2 class="month-header">${header}</h2>
          <div class="game-grid">
            ${[satDetails, sunDetails].map(game => game ? `
              <div class="game-card" data-date="${game.date}">
                ${game.scorers && game.scorers.length ? `
                  <div class="scorers-list">${game.scorers.join(', ')}</div>
                ` : ''}
                <div class="game-date">${game.date || ''}</div>
                <h2>${game.opponent ? 'vs ' + game.opponent : ''}</h2>
                ${game.formation ? `<div class="formation">${game.formation}</div>` : ''}
                <div>${game.competition || ''}</div>
                <div class="game-meta">
                  <span class="score ${scoreClass(game.score || '')}">${game.score || ''}</span>
                </div>
                <a href="game.html?id=${game.id}" class="view-link">View Plan</a>
              </div>
            ` : `
              <div class="game-card empty-card">
                <div class="game-date"></div>
                <h2>No Game</h2>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');

      // Highlight current week
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
      startOfWeek.setHours(0,0,0,0);
      const endOfWeek = new Date(today);
      endOfWeek.setDate(today.getDate() + (6 - today.getDay())); // Saturday
      endOfWeek.setHours(23,59,59,999);

      document.querySelectorAll('.game-card[data-date]').forEach(card => {
        const gameDateStr = card.getAttribute('data-date');
        if (gameDateStr) {
          const gameDate = new Date(gameDateStr);
          if (gameDate >= startOfWeek && gameDate <= endOfWeek) {
            card.classList.add('highlight-week');
          }
        }
      });

      // Scroll to first highlighted game card (with delay for iPad/Safari)
      const firstHighlighted = document.querySelector('.game-card.highlight-week');
      if (firstHighlighted) {
        setTimeout(() => {
          firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300); // 300ms delay helps on iPad/Safari
      }
    });
  </script>
</body>
